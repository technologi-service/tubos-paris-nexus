---
import { actions } from "astro:actions";

// 1. Lógica de Servidor (Se ejecuta al cargar la página)
const { data: periodoRaw, error: periodoError } = await Astro.callAction(actions.getPeriodo, {});

// Procesamos el dato aquí arriba para tener el número limpio
let periodoValor = 1; // Valor por defecto
if (periodoRaw && Array.isArray(periodoRaw) && periodoRaw.length > 0) {
    periodoValor = Number(periodoRaw[0].periodo);
}
// Ahora 'periodoValor' tiene el número (ej: 6) listo para usarse
---

{/* Overlay de Éxito */}
<div id="calc-success-overlay" class="hidden fixed inset-0 bg-black/20 backdrop-blur-[2px] items-center justify-center z-50 transition-all">
    <div class="bg-white border border-[#0f4c65] shadow-xl px-6 py-4 rounded text-center">
        <span class="text-[#0f4c65] font-bold text-sm">✓ Cálculo iniciado correctamente</span>
    </div>
</div>

<div class="flex flex-col gap-8 mt-8">

    <div class="flex justify-center w-full">
        {/* 2. Pasamos el dato del servidor al cliente usando data-periodo */}
        <button
            type="button"
            id="btn-trigger-webhook"
            data-periodo={periodoValor}
            class="group relative w-full max-w-3xl py-5 px-8 bg-linear-to-br from-[#0f4c65] to-[#165f7d] text-white rounded-2xl shadow-lg hover:shadow-2xl hover:scale-[1.01] transition-all duration-300 flex items-center justify-center gap-5 overflow-hidden"
        >
            <div class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3 group-hover:rotate-12 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <div class="flex flex-col items-start">
                <span class="text-2xl font-bold tracking-wide">CALCULAR</span>
                <span class="text-xs uppercase tracking-widest opacity-80 group-hover:opacity-100">Procesar Modelo</span>
            </div>
        </button>
    </div>

    <div class="space-y-4">
        <div class="w-full h-64 bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center text-slate-400 relative overflow-hidden group">
            <div class="absolute inset-0 opacity-10 bg-[radial-gradient(#0f4c65_1px,transparent_1px)] bg-size-[16px_16px]"></div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
            </svg>
            <span class="text-xl font-semibold z-10">Visualización de Datos</span>
            <span class="text-sm z-10">El gráfico se generará aquí tras calcular</span>
        </div>

        <button
          type="button"
          id="btn-powerbi"
          class="w-full bg-white border-2 border-[#0f4c65] text-[#0f4c65] py-3 text-lg font-bold rounded-lg shadow-sm hover:bg-[#0f4c65] hover:text-white transition-all duration-300 flex items-center justify-center gap-2 group"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" fill="currentColor">
               <path d="M4 18h4V6H4v12zm12-8v8h4v-8h-4zm-6 4v4h4v-4h-4z"/>
            </svg>
            Acceso a Power BI
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btnWebhook = document.getElementById('btn-trigger-webhook');
        const btnPowerBi = document.getElementById('btn-powerbi');
        const overlay = document.getElementById('calc-success-overlay');

        const WEBHOOK_URL = 'https://kukulcanai.app.n8n.cloud/webhook/recalcular-score-tubos-paris';
        const POWERBI_URL = 'https://app.powerbi.com/';

        if (btnWebhook) {
            btnWebhook.addEventListener('click', async () => {
                const originalContent = btnWebhook.innerHTML;

                // 3. Leer el dato que pusimos en el atributo data-periodo
                const periodoGuardado = btnWebhook.getAttribute('data-periodo');
                const periodoNumero = Number(periodoGuardado);

                // A. Loading Visual
                // @ts-ignore
                btnWebhook.disabled = true;
                btnWebhook.innerHTML = `
                    <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="ml-2 text-lg">Enviando a Motor...</span>
                `;

                try {


                    // B. LLAMADA AL WEBHOOK (Sin consultar BD, usando el dato inyectado)
                    const res = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            timestamp: new Date().toISOString(),
                            action: 'recalcular_vcs',
                            periodo: periodoNumero,
                            origen: 'kailoop_nexus'
                        })
                    });

                    if (res.ok) {
                        if (overlay) {
                            overlay.classList.remove('hidden');
                            overlay.classList.add('flex');
                            setTimeout(() => {
                                overlay.classList.remove('flex');
                                overlay.classList.add('hidden');
                            }, 3000);
                        }
                    } else {
                        console.error("Error Webhook:", res.status);
                        alert(`Error: El motor respondió con estado ${res.status}`);
                    }

                } catch (error) {
                    console.error("Error:", error);
                    alert("Ocurrió un error. Revisa consola.");
                } finally {
                    // C. Restaurar botón
                    // @ts-ignore
                    btnWebhook.disabled = false;
                    btnWebhook.innerHTML = originalContent;
                }
            });
        }

        if (btnPowerBi) {
            btnPowerBi.addEventListener('click', () => {
                window.open(POWERBI_URL, '_blank');
            });
        }
    });
</script>

---
import '../../styles/global.css';
import { actions } from "astro:actions";

// 1. Lógica de Servidor: Obtener datos
const { data: periodoRaw, error: periodoError } = await Astro.callAction(actions.getPeriodo, {});

// 2. Preparación de Datos
// Si hay datos en la BD, los usamos. Si no, mock con ID 1 y valor 1.
const periodosRender = (periodoRaw && Array.isArray(periodoRaw) && periodoRaw.length > 0)
    ? periodoRaw
    : [{ id: 1, periodo: 1 }];
---

{/* --- 1. Overlay de Éxito --- */}
<div id="period-success-overlay" class="hidden fixed inset-0 bg-black/20 backdrop-blur-[2px] items-center justify-center z-50 transition-all">
    <div class="bg-white border border-[#0f4c65] shadow-xl px-6 py-4 rounded text-center">
        <span class="text-[#0f4c65] font-bold text-sm">✓ Configuración guardada. Recargando...</span>
    </div>
</div>

{/* Mensaje de Error de Carga */}
{periodoError && <div class="fixed top-4 right-4 bg-red-100 text-red-700 px-4 py-2 rounded border border-red-200 z-50">{periodoError.message}</div>}

<div class="flex flex-col items-center justify-center py-4">

    {/* --- 2. El Formulario --- */}
    <form id="form-periodo" class="flex items-center gap-4" autocomplete="off">

        <label class="text-base font-semibold text-gray-700">
            Periodo (Meses):
        </label>

        {periodosRender.map((p) => (
            <div class="relative group">
                <div
                    class="w-24 h-10 bg-[#0f4c65] rounded shadow
                           flex items-center justify-center text-white font-bold text-lg
                           focus-within:ring-2 focus-within:ring-offset-1 focus-within:ring-[#0f4c65] transition-all"
                >
                    {/* ID oculto */}
                    <input type="hidden" name="id" value={p.id} />

                    {/* Input Numérico */}
                    <input
                        type="number"
                        name="periodo"
                        min="1"
                        max="12"
                        step="1"
                        value={p.periodo ?? 1}
                        class="w-full h-full bg-transparent text-center text-white font-bold text-lg focus:outline-none appearance-none cursor-pointer placeholder-white/50"
                        data-periodo-input
                    />
                </div>
            </div>
        ))}
    </form>
</div>

{/* --- 3. La Lógica (Auto-save + Reload) --- */}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const inputs = document.querySelectorAll('[data-periodo-input]');
        const overlay = document.getElementById('period-success-overlay');
        const form = document.getElementById('form-periodo');

        inputs.forEach(element => {
            const input = element as HTMLInputElement;

            input.addEventListener('change', async (e) => {
                // 1. Validación básica
                let newValue = Number(input.value);

                if (isNaN(newValue) || newValue < 1) newValue = 1;
                if (newValue > 12) newValue = 12;
                input.value = String(newValue);

                // Obtener ID
                const container = input.closest('div');
                const idInput = container?.querySelector('input[name="id"]') as HTMLInputElement;
                const id = idInput ? Number(idInput.value) : 1;

                // 2. Efecto Visual de Carga
                if (form) {
                    // @ts-ignore
                    form.style.opacity = '0.7';
                    document.body.style.cursor = 'wait';
                }

                try {
                    // 3. Llamada a la API
                    const res = await fetch('/api/update-periodo', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: id, periodo: newValue })
                    });

                    const result = await res.json();

                    // 4. Manejo de Respuesta y RECARGA
                    if (res.ok) {
                        // Mostrar Overlay
                        if (overlay) {
                            overlay.classList.remove('hidden');
                            overlay.classList.add('flex');

                            // Esperamos 1 segundo para que el usuario vea el mensaje "Guardado"
                            // y luego recargamos la página.
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            // Si no hay overlay, recargar directo
                            window.location.reload();
                        }

                    } else {
                        alert("Error al guardar: " + (result.error || "Error desconocido"));
                        // Restaurar estado visual si falló (si no falló, se recargará la página)
                        if (form) {
                            // @ts-ignore
                            form.style.opacity = '1';
                            document.body.style.cursor = 'default';
                        }
                    }

                } catch (err) {
                    console.error(err);
                    alert("Error de conexión.");
                    if (form) {
                        // @ts-ignore
                        form.style.opacity = '1';
                        document.body.style.cursor = 'default';
                    }
                }
            });
        });
    });
</script>
